<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#58CC02">
    <meta name="description" content="Learn Lithuanian with daily lessons and streak tracking">
    <title>Learn Lithuanian - Mokykis Lietuvių</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🇱🇹</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #58CC02;
            --primary-dark: #46A302;
            --secondary-color: #1CB0F6;
            --danger-color: #FF4B4B;
            --success-color: #58CC02;
            --warning-color: #FFC800;
            --text-dark: #3C3C3C;
            --text-light: #777777;
            --bg-light: #F7F7F7;
            --border-color: #E5E5E5;
            --white: #FFFFFF;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 20px 0;
            box-shadow: var(--shadow);
        }

        .app-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .streak-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .fire-icon {
            font-size: 28px;
            animation: flame 1.5s ease-in-out infinite;
        }

        @keyframes flame {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .progress-overview {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .progress-overview h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .xp-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 24px;
            font-weight: 700;
            color: var(--warning-color);
        }

        .lesson-path {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .section-header {
            background: var(--white);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            box-shadow: var(--shadow);
        }

        .section-header h3 {
            font-size: 18px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-progress {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-light);
        }

        .lesson-card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            gap: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .lesson-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .lesson-card.locked:hover {
            transform: none;
            box-shadow: var(--shadow);
        }

        .lesson-card.completed {
            border: 2px solid var(--success-color);
        }

        .lesson-icon {
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
        }

        .lesson-info {
            flex: 1;
        }

        .lesson-info h3 {
            font-size: 18px;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .lesson-info p {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .lesson-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .xp-badge, .difficulty-badge {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .xp-badge {
            background: #FFF7E6;
            color: var(--warning-color);
        }

        .difficulty-badge {
            background: var(--bg-light);
            color: var(--text-light);
            text-transform: capitalize;
        }

        .btn {
            display: inline-block;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            max-width: 400px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
            box-shadow: 0 4px 0 var(--primary-dark);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--primary-dark);
        }

        .btn-primary:disabled {
            background: var(--border-color);
            color: var(--text-light);
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-success {
            background: var(--success-color);
            color: var(--white);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--text-dark);
            border: 2px solid var(--border-color);
        }

        #start-lesson-btn {
            margin: 0 auto;
            display: block;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        #lesson-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 80px;
            background: var(--white);
            z-index: 100;
            overflow-y: auto;
        }

        .lesson-header {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-icon {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: var(--text-dark);
        }

        .progress-bar {
            flex: 1;
            height: 16px;
            background: var(--bg-light);
            border-radius: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
            width: 0;
        }

        .lesson-content {
            padding: 32px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        #question-container {
            margin-bottom: 32px;
        }

        .question {
            text-align: center;
        }

        .question h3 {
            font-size: 24px;
            margin-bottom: 24px;
            color: var(--text-dark);
        }

        #answer-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .answer-option {
            background: var(--white);
            border: 3px solid var(--border-color);
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .answer-option:hover:not(:disabled) {
            border-color: var(--text-light);
            background: var(--bg-light);
        }

        .answer-option.selected {
            border-color: var(--secondary-color);
            background: #E8F5FE;
        }

        .answer-option.correct {
            border-color: var(--success-color);
            background: #E8F7E8;
        }

        .answer-option.incorrect {
            border-color: var(--danger-color);
            background: #FFE8E8;
        }

        .answer-option:disabled {
            cursor: not-allowed;
        }

        .feedback-panel {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 24px;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .feedback-panel:not(.hidden) {
            transform: translateY(0);
        }

        .feedback-panel.correct {
            background: #E8F7E8;
            border-top: 4px solid var(--success-color);
        }

        .feedback-panel.incorrect {
            background: #FFE8E8;
            border-top: 4px solid var(--danger-color);
        }

        .feedback-content {
            max-width: 600px;
            margin: 0 auto;
        }

        #feedback-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        #feedback-message {
            font-size: 16px;
            margin-bottom: 16px;
        }

        #results-screen {
            padding-top: 60px;
        }

        .results-content {
            text-align: center;
        }

        .results-content h2 {
            font-size: 32px;
            margin-bottom: 32px;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat {
            background: var(--white);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .stat-value {
            display: block;
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label {
            display: block;
            font-size: 14px;
            color: var(--text-light);
        }

        .practice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .practice-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .practice-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .practice-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .practice-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .practice-card p {
            font-size: 12px;
            color: var(--text-light);
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 32px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 16px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .profile-level {
            font-size: 16px;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .stat-card-label {
            font-size: 14px;
            color: var(--text-light);
        }

        .achievements {
            background: var(--white);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .achievements h3 {
            margin-bottom: 16px;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
        }

        .achievement {
            text-align: center;
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-light);
        }

        .achievement.unlocked {
            background: #FFF7E6;
        }

        .achievement-icon {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .achievement-name {
            font-size: 11px;
            color: var(--text-dark);
        }

        .settings-section {
            background: var(--white);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .settings-section h3 {
            margin-bottom: 16px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        .nav-item {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 16px;
            color: var(--text-light);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }

            .practice-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        @keyframes slideDown {
    from {
        transform: translateX(-50%) translateY(-100px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    to {
        transform: translateX(-50%) translateY(-100px);
        opacity: 0;
    }
}
    </style>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <div class="container">
                <h1>🇱🇹 Learn Lithuanian</h1>
                <div class="streak-display">
                    <span class="fire-icon">🔥</span>
                    <span id="streak-count">0</span>
                    <span class="streak-label">day streak</span>
                </div>
            </div>
        </header>

        <main id="main-content">
            <!-- Home Screen -->
            <section id="home-screen" class="screen active">
                <div class="container">
                    <div class="progress-overview">
                        <h2>Your Progress</h2>
                        <div class="xp-display">
                            <span class="xp-icon">⭐</span>
                            <span id="total-xp">0</span>
                            <span>XP</span>
                        </div>
                    </div>

                    <div class="lesson-path" id="lesson-path"></div>

                    <button id="start-lesson-btn" class="btn btn-primary">
                        Start Lesson
                    </button>
                    <button id="debug-lessons-btn" class="btn btn-secondary" style="margin-top: 10px;">
    🐛 Debug Lessons
</button>
                </div>
            </section>
            

            <!-- Practice Screen -->
            <section id="practice-screen" class="screen">
                <div class="container">
                    <h2 style="margin-bottom: 24px;">Practice</h2>
                    
                    <div class="practice-grid">
                        <div class="practice-card" id="practice-weak-words">
                            <div class="practice-icon">🎯</div>
                            <h3>Weak Words</h3>
                            <p>Review difficult vocabulary</p>
                        </div>
                        
                        <div class="practice-card" id="practice-review">
                            <div class="practice-icon">🔄</div>
                            <h3>Review</h3>
                            <p>Practice all learned words</p>
                        </div>
                        
                        <div class="practice-card" id="practice-speaking">
                            <div class="practice-icon">🎤</div>
                            <h3>Speaking</h3>
                            <p>Practice pronunciation</p>
                        </div>
                        
                        <div class="practice-card" id="practice-listening">
                            <div class="practice-icon">👂</div>
                            <h3>Listening</h3>
                            <p>Test your comprehension</p>
                        </div>
                    </div>

                    <div class="progress-overview">
                        <h3>Vocabulary Progress</h3>
                        <div style="margin-top: 16px;">
                            <p style="color: var(--text-light); margin-bottom: 8px;">
                                Words Learned: <strong id="vocab-count">0</strong>
                            </p>
                            <p style="color: var(--text-light);">
                                Words to Review: <strong id="review-count">0</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </section>
<!-- Practice Exercise Screen -->
<section id="practice-exercise-screen" class="screen">
    <div class="lesson-header">
        <button id="exit-practice-btn" class="btn-icon">✕</button>
        <div class="progress-bar">
            <div id="practice-progress" class="progress-fill"></div>
        </div>
        <span id="practice-counter" style="margin-left: 12px; font-weight: 600;">0/10</span>
    </div>

    <div class="lesson-content">
        <div id="practice-question-container"></div>

        <div class="answer-section">
            <div id="practice-answer-options"></div>
            <button id="practice-check-btn" class="btn btn-primary" disabled>
                Check
            </button>
        </div>
    </div>

    <div id="practice-feedback-panel" class="feedback-panel hidden">
        <div class="feedback-content">
            <h3 id="practice-feedback-title"></h3>
            <p id="practice-feedback-message"></p>
            <button id="practice-continue-btn" class="btn btn-success">
                Continue
            </button>
        </div>
    </div>
</section>

<!-- Practice Results Screen -->
<section id="practice-results-screen" class="screen">
    <div class="container">
        <div class="results-content">
            <h2 id="practice-results-title">Practice Complete! 🎉</h2>
            <div class="results-stats">
                <div class="stat">
                    <span class="stat-value" id="practice-correct-answers">0</span>
                    <span class="stat-label">Correct</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="practice-xp-earned">0</span>
                    <span class="stat-label">XP Earned</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="practice-accuracy">0</span>
                    <span class="stat-label">Accuracy</span>
                </div>
            </div>
            <button id="back-to-practice-btn" class="btn btn-primary">
                Back to Practice
            </button>
        </div>
    </div>
</section>
    <!-- Analytics Screen -->
<section id="analytics-screen" class="screen">
    <div class="container">
        <h2 style="margin-bottom: 24px;">📊 Your Progress</h2>
        
        <div class="progress-overview">
            <h3>This Week</h3>
            <div class="stats-grid" style="margin-top: 16px;">
                <div class="stat-card">
                    <div class="stat-card-value" id="week-xp">0</div>
                    <div class="stat-card-label">XP Earned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="week-lessons">0</div>
                    <div class="stat-card-label">Lessons</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="week-accuracy">0%</div>
                    <div class="stat-card-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="week-words">0</div>
                    <div class="stat-card-label">New Words</div>
                </div>
            </div>
        </div>

        <div class="progress-overview" style="margin-top: 24px;">
            <h3>Areas to Improve</h3>
            <div id="weak-areas-list" style="margin-top: 16px;">
                <!-- Will be populated by JS -->
            </div>
        </div>

        <div class="progress-overview" style="margin-top: 24px;">
            <h3>7-Day Streak</h3>
            <div id="streak-calendar" style="display: flex; gap: 8px; margin-top: 16px; justify-content: space-around;">
                <!-- Will be populated by JS -->
            </div>
        </div>
    </div>
</section>        
            <!-- Profile Screen -->
            <section id="profile-screen" class="screen">
                <div class="container">
                    <div class="profile-header">
                        <div class="profile-avatar">👤</div>
                        <div class="profile-name">Lithuanian Learner</div>
                        <div class="profile-level">Level <span id="user-level">1</span></div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-value" id="profile-xp">0</div>
                            <div class="stat-card-label">Total XP</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-value" id="profile-streak">0</div>
                            <div class="stat-card-label">Day Streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-value" id="profile-lessons">0</div>
                            <div class="stat-card-label">Lessons Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-value" id="profile-vocab">0</div>
                            <div class="stat-card-label">Words Learned</div>
                        </div>
                    </div>

                    <div class="achievements">
                        <h3>Achievements</h3>
                        <div class="achievement-grid" id="achievements-container"></div>
                    </div>

                    <div class="settings-section">
                        <h3>Settings</h3>
                        <div class="setting-item">
                            <span>Daily Goal</span>
                            <span id="daily-goal">50 XP</span>
                        </div>
                        <div class="setting-item">
                            <span>Sound Effects</span>
                            <span>✓ Enabled</span>
                        </div>
                        <div class="setting-item">
                            <span>Daily Reminder</span>
                            <span>19:00</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Lesson Screen -->
            <section id="lesson-screen" class="screen">
                <div class="lesson-header">
                    <button id="exit-lesson-btn" class="btn-icon">✕</button>
                    <div class="progress-bar">
                        <div id="lesson-progress" class="progress-fill"></div>
                    </div>
                </div>

                <div class="lesson-content">
                    <div id="question-container"></div>

                    <div class="answer-section">
                        <div id="answer-options"></div>
                        <button id="check-answer-btn" class="btn btn-primary" disabled>
                            Check
                        </button>
                    </div>
                </div>

                <div id="feedback-panel" class="feedback-panel hidden">
                    <div class="feedback-content">
                        <h3 id="feedback-title"></h3>
                        <p id="feedback-message"></p>
                        <button id="continue-btn" class="btn btn-success">
                            Continue
                        </button>
                    </div>
                </div>
            </section>

            <!-- Results Screen -->
            <section id="results-screen" class="screen">
                <div class="container">
                    <div class="results-content">
                        <h2>Lesson Complete! 🎉</h2>
                        <div class="results-stats">
                            <div class="stat">
                                <span class="stat-value" id="correct-answers">0</span>
                                <span class="stat-label">Correct</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="xp-earned">0</span>
                                <span class="stat-label">XP Earned</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="accuracy">0</span>
                                <span class="stat-label">Accuracy</span>
                            </div>
                        </div>
                        <button id="continue-learning-btn" class="btn btn-primary">
                            Continue Learning
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-screen="home">
                <span class="nav-icon">🏠</span>
                <span class="nav-label">Home</span>
            </button>
            <button class="nav-item" data-screen="practice">
                <span class="nav-icon">💪</span>
                <span class="nav-label">Practice</span>
            </button>
            <button class="nav-item" data-screen="analytics">
    <span class="nav-icon">📊</span>
    <span class="nav-label">Progress</span>
</button>
            <button class="nav-item" data-screen="profile">
                <span class="nav-icon">👤</span>
                <span class="nav-label">Profile</span>
            </button>
        </nav>
    </div>

    <script>
        // ============ STORAGE ============
        const Storage = {
            getUserData() {
                try {
                    const data = localStorage.getItem('lithuanianLearner');
                    return data ? JSON.parse(data) : this.getDefaultUserData();
                } catch (e) {
                    console.error('Error reading user data:', e);
                    return this.getDefaultUserData();
                }
            },

            getDefaultUserData() {
                return {
                    streak: 0,
                    lastStudyDate: null,
                    totalXP: 0,
                    lessonsCompleted: [],
                    currentLesson: 1,
                    vocabulary: {},
                    settings: {
                        dailyGoal: 50,
                        soundEnabled: true,
                        notificationsEnabled: true,
                        reminderTime: '19:00'
                    }
                };
            },

            saveUserData(data) {
                try {
                    localStorage.setItem('lithuanianLearner', JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving user data:', e);
                }
            },

            addXP(amount) {
                const data = this.getUserData();
                data.totalXP += amount;
                this.saveUserData(data);
                return data.totalXP;
            },

            completeLesson(lessonId, score) {
                const data = this.getUserData();
                if (!data.lessonsCompleted.find(l => l.id === lessonId)) {
                    data.lessonsCompleted.push({
                        id: lessonId,
                        completedAt: new Date().toISOString(),
                        score: score
                    });
                }
                this.saveUserData(data);
            },

addVocabulary(word, strength = 1, isCorrect = true) {
    const data = this.getUserData();
    const now = new Date();
    
    // Ensure valid date
    if (isNaN(now.getTime())) {
        console.error('Invalid date in addVocabulary');
        return;
    }
    
    if (!data.vocabulary[word]) {
        data.vocabulary[word] = {
            easeFactor: 2.5,
            interval: 1,
            repetitions: 0,
            nextReview: now.toISOString(),
            lastReviewed: now.toISOString(),
            timesCorrect: 0,
            timesWrong: 0,
            totalReviews: 0
        };
    }
    
    const vocab = data.vocabulary[word];
    vocab.totalReviews++;
    vocab.lastReviewed = now.toISOString();
    
    if (isCorrect) {
        vocab.timesCorrect++;
        vocab.repetitions++;
        
        // SM-2 Algorithm
        if (vocab.repetitions === 1) {
            vocab.interval = 1;
        } else if (vocab.repetitions === 2) {
            vocab.interval = 6;
        } else {
            vocab.interval = Math.round(vocab.interval * vocab.easeFactor);
        }
        
        // Adjust ease factor
        vocab.easeFactor = Math.max(1.3, vocab.easeFactor + (0.1 - (5 - 4) * (0.08 + (5 - 4) * 0.02)));
    } else {
        vocab.timesWrong++;
        vocab.repetitions = 0;
        vocab.interval = 1;
        vocab.easeFactor = Math.max(1.3, vocab.easeFactor - 0.2);
    }
    
    // Set next review date - ensure it's valid
    const nextReviewDate = new Date(now);
    nextReviewDate.setDate(nextReviewDate.getDate() + vocab.interval);
    
    if (isNaN(nextReviewDate.getTime())) {
        console.error('Invalid next review date');
        vocab.nextReview = now.toISOString();
    } else {
        vocab.nextReview = nextReviewDate.toISOString();
    }
    
    this.saveUserData(data);
},
getWordsForReview(limit = 10) {
    const data = this.getUserData();
    const now = new Date();
    const words = Object.entries(data.vocabulary)
        .filter(([word, stats]) => new Date(stats.nextReview) <= now)
        .map(([word, stats]) => ({ word, ...stats }))
        .sort((a, b) => new Date(a.nextReview) - new Date(b.nextReview))
        .slice(0, limit);
    return words;
},
getWeakWords(limit = 10) {
    const data = this.getUserData();
    const words = Object.entries(data.vocabulary)
        .map(([word, stats]) => ({ word, ...stats }))
        .sort((a, b) => a.strength - b.strength)
        .slice(0, limit);
    return words;
},
};

// ============ STREAK MANAGER ============
        const StreakManager = {
            updateStreak() {
                const data = Storage.getUserData();
                const today = new Date().toDateString();
                const lastDate = data.lastStudyDate ? new Date(data.lastStudyDate).toDateString() : null;
                
                if (lastDate === today) {
                    return data.streak;
                }
                
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                if (lastDate === yesterdayStr) {
                    data.streak += 1;
                } else if (lastDate === null) {
                    data.streak = 1;
                } else {
                    data.streak = 1;
                }
                
                data.lastStudyDate = new Date().toISOString();
                Storage.saveUserData(data);
                
                this.displayStreak(data.streak);
                return data.streak;
            },

            displayStreak(streak) {
                const streakElement = document.getElementById('streak-count');
                if (streakElement) {
                    streakElement.textContent = streak;
                }
            },

            init() {
                const data = Storage.getUserData();
                this.displayStreak(data.streak);
            },

            checkDailyReview() {
                const words = Storage.getWordsForReview(1);
                if (words.length > 0) {
                    this.showReviewReminder(words.length);
                }
            },

            showReviewReminder(count) {
                const userData = Storage.getUserData();
                const today = new Date().toDateString();
                const lastShown = localStorage.getItem('lastReviewReminder');
                
                if (lastShown === today) return;
                
                const reminderDiv = document.createElement('div');
                reminderDiv.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--warning-color);
                    color: var(--text-dark);
                    padding: 16px 24px;
                    border-radius: 12px;
                    box-shadow: var(--shadow-lg);
                    z-index: 1000;
                    font-weight: 600;
                    cursor: pointer;
                    animation: slideDown 0.3s ease;
                `;
                reminderDiv.innerHTML = `
                    📚 ${count} word${count > 1 ? 's' : ''} ready for review!
                    <span style="display: block; font-size: 12px; margin-top: 4px; opacity: 0.8;">Tap to practice</span>
                `;
                
                reminderDiv.onclick = () => {
                    document.body.removeChild(reminderDiv);
                    App.navigateToScreen('practice');
                    setTimeout(() => PracticeManager.startReview(), 300);
                };
                
                document.body.appendChild(reminderDiv);
                localStorage.setItem('lastReviewReminder', today);
                
                setTimeout(() => {
                    if (document.body.contains(reminderDiv)) {
                        reminderDiv.style.animation = 'slideUp 0.3s ease';
                        setTimeout(() => document.body.removeChild(reminderDiv), 300);
                    }
                }, 5000);
            }
        };
        // ============ LESSONS DATA ============
        const LESSONS_DATA = {
            lessons: [
                {
                    id: 1,
                    section: "Basics",
                    title: "Greetings & Basics",
                    description: "Learn essential greetings and basic phrases",
                    difficulty: "beginner",
                    xp: 10,
                    vocabulary: [
                        { lithuanian: "labas", english: "hello", pronunciation: "lah-bahs" },
                        { lithuanian: "ačiū", english: "thank you", pronunciation: "ah-choo" },
                        { lithuanian: "taip", english: "yes", pronunciation: "tayp" },
                        { lithuanian: "ne", english: "no", pronunciation: "neh" },
                        { lithuanian: "gerai", english: "okay/good", pronunciation: "geh-rai" },
                        { lithuanian: "prašau", english: "please", pronunciation: "prah-show" }
                    ],
                    exercises: [
                        { type: "translation", question: "How do you say 'hello' in Lithuanian?", answer: "labas", options: ["labas", "ačiū", "viso gero", "gerai"] },
                        { type: "multiple-choice", question: "What does 'ačiū' mean?", answer: "thank you", options: ["hello", "goodbye", "thank you", "please"] },
                        { type: "multiple-choice", question: "What is 'yes' in Lithuanian?", answer: "taip", options: ["ne", "taip", "labas", "gerai"] },
                        { type: "translation", question: "How do you say 'no' in Lithuanian?", answer: "ne", options: ["ne", "taip", "ačiū", "labas"] },
                        { type: "multiple-choice", question: "What does 'prašau' mean?", answer: "please", options: ["thank you", "please", "sorry", "hello"] }
                    ]
                },
                {
                    id: 2,
                    section: "Basics",
                    title: "Numbers 1-10",
                    description: "Learn numbers from one to ten",
                    difficulty: "beginner",
                    xp: 10,
                    vocabulary: [
                        { lithuanian: "vienas", english: "one", pronunciation: "vien-us" },
                        { lithuanian: "du", english: "two", pronunciation: "doo" },
                        { lithuanian: "trys", english: "three", pronunciation: "trees" },
                        { lithuanian: "keturi", english: "four", pronunciation: "ket-u-ri" },
                        { lithuanian: "penki", english: "five", pronunciation: "pen-ki" }
                    ],
                    exercises: [
                        { type: "translation", question: "How do you say 'one' in Lithuanian?", answer: "vienas", options: ["vienas", "du", "trys", "keturi"] },
                        { type: "multiple-choice", question: "What does 'du' mean?", answer: "two", options: ["one", "two", "three", "four"] },
                        { type: "translation", question: "How do you say 'five'?", answer: "penki", options: ["penki", "keturi", "trys", "du"] }
                    ]
                },
                {
                    id: 3,
                    section: "Basics",
                    title: "Colors",
                    description: "Learn basic color names",
                    difficulty: "beginner",
                    xp: 10,
                    vocabulary: [
                        { lithuanian: "raudona", english: "red", pronunciation: "row-do-na" },
                        { lithuanian: "mėlyna", english: "blue", pronunciation: "may-lee-na" },
                        { lithuanian: "žalia", english: "green", pronunciation: "zha-lee-a" },
                        { lithuanian: "geltona", english: "yellow", pronunciation: "gel-to-na" }
                    ],
                    exercises: [
                        { type: "translation", question: "How do you say 'red' in Lithuanian?", answer: "raudona", options: ["raudona", "mėlyna", "žalia", "geltona"] },
                        { type: "multiple-choice", question: "What does 'mėlyna' mean?", answer: "blue", options: ["red", "blue", "green", "yellow"] },
                        { type: "translation", question: "How do you say 'green'?", answer: "žalia", options: ["žalia", "geltona", "raudona", "mėlyna"] }
                    ]
                },
                {
                    id: 4,
                    section: "Family",
                    title: "Family Members",
                    description: "Learn family member terms",
                    difficulty: "beginner",
                    xp: 15,
                    vocabulary: [
                        { lithuanian: "mama", english: "mother", pronunciation: "mah-mah" },
                        { lithuanian: "tėvas", english: "father", pronunciation: "tay-vahs" },
                        { lithuanian: "sesuo", english: "sister", pronunciation: "seh-soo-oh" },
                        { lithuanian: "brolis", english: "brother", pronunciation: "broh-lis" }
                    ],
                    exercises: [
                        { type: "translation", question: "How do you say 'mother'?", answer: "mama", options: ["mama", "tėvas", "sesuo", "brolis"] },
                        { type: "multiple-choice", question: "What does 'brolis' mean?", answer: "brother", options: ["sister", "brother", "mother", "father"] },
                        { type: "translation", question: "How do you say 'father'?", answer: "tėvas", options: ["tėvas", "mama", "brolis", "sesuo"] }
                    ]
                },
                {
                    id: 5,
                    section: "Food",
                    title: "Basic Foods",
                    description: "Learn common food items",
                    difficulty: "beginner",
                    xp: 15,
                    vocabulary: [
                        { lithuanian: "duona", english: "bread", pronunciation: "dwo-na" },
                        { lithuanian: "pienas", english: "milk", pronunciation: "pee-eh-nas" },
                        { lithuanian: "vanduo", english: "water", pronunciation: "van-doo-o" },
                        { lithuanian: "obuolys", english: "apple", pronunciation: "o-bwo-lis" }
                    ],
                    exercises: [
                        { type: "translation", question: "How do you say 'bread'?", answer: "duona", options: ["duona", "pienas", "vanduo", "obuolys"] },
                        { type: "multiple-choice", question: "What does 'pienas' mean?", answer: "milk", options: ["water", "milk", "bread", "apple"] },
                        { type: "translation", question: "How do you say 'water'?", answer: "vanduo", options: ["vanduo", "pienas", "duona", "obuolys"] }
                    ]
                }
            ]
        };

        // ============ ACHIEVEMENTS DATA ============
        const ACHIEVEMENTS = [
            { id: 1, name: "First Step", icon: "🎯", requirement: 1, type: "lessons" },
            { id: 2, name: "Getting Started", icon: "🌱", requirement: 3, type: "lessons" },
            { id: 3, name: "Dedicated", icon: "💪", requirement: 5, type: "lessons" },
            { id: 4, name: "Week Warrior", icon: "⭐", requirement: 7, type: "streak" },
            { id: 5, name: "Vocabulary 20", icon: "📖", requirement: 20, type: "vocabulary" },
            { id: 6, name: "XP Hunter", icon: "💎", requirement: 100, type: "xp" }
        ];

// ============ GEMINI AI GENERATOR ============
const GeminiAI = {
    API_KEY: 'AIzaSyDZBrdgDD0y6-v_w_bt197O7PlKGxLYhhM', //test token
    API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent',
    
async generateLesson(lessonNumber, userData) {
    const topics = [
        'days of the week and time',
        'common verbs (go, come, eat, drink, see)',
        'body parts',
        'weather and seasons',
        'shopping and money',
        'asking for directions',
        'at a restaurant',
        'transportation',
        'past tense basics',
        'future tense basics'
    ];
    
    const topic = topics[lessonNumber - 6] || 'conversation practice';
    
const prompt = `Create a Lithuanian language lesson in valid JSON format.

Lesson number: ${lessonNumber}
Topic: ${topic}
Level: beginner

IMPORTANT: Focus on PRACTICAL COMMUNICATION. Include full sentences, not just isolated words.

Create a lesson with exactly this structure (ID must be ${lessonNumber}):
{
  "id": ${lessonNumber},
  "section": "Basics",
  "title": "Topic Name",
  "description": "Short description",
  "difficulty": "beginner",
  "xp": 15,
  "grammarFocus": "One specific grammar point explained simply",
  "culturalNote": "Brief interesting fact about Lithuania (optional)",
  "vocabulary": [
    {
      "lithuanian": "word1", 
      "english": "translation1", 
      "pronunciation": "phonetic1",
      "exampleSentence": "Full Lithuanian sentence using this word",
      "sentenceTranslation": "English translation of the sentence",
      "wordType": "noun/verb/adjective/etc"
    },
    {
      "lithuanian": "word2", 
      "english": "translation2", 
      "pronunciation": "phonetic2",
      "exampleSentence": "Another full sentence",
      "sentenceTranslation": "English translation",
      "wordType": "noun/verb/adjective/etc"
    }
    // Include 5-7 words total
  ],
  "exercises": [
    {"type": "multiple-choice", "question": "What does 'word' mean?", "answer": "meaning", "options": ["meaning", "opt2", "opt3", "opt4"]},
    {"type": "translation", "question": "How do you say 'X' in Lithuanian?", "answer": "word", "options": ["word", "opt2", "opt3", "opt4"]},
    {"type": "fill-blank", "sentence": "Aš ____ kavą", "answer": "geriu", "translation": "I drink coffee", "options": ["geriu", "valgau", "matau", "noriu"]},
    {"type": "sentence-builder", "words": ["aš", "esu", "studentas"], "correctOrder": ["aš", "esu", "studentas"], "translation": "I am a student"},
    {"type": "translation-full", "question": "Translate: I am learning Lithuanian", "answer": "Aš mokausi lietuvių kalbos", "hints": ["Use 'mokausi' for 'am learning'"]},
    // Include 5-7 exercises with variety
  ]
}

CRITICAL: 
- All vocabulary MUST have example sentences showing usage in context
- Include at least 2 "fill-blank" exercises with real sentences
- Include at least 1 "sentence-builder" exercise
- Make exercises progressively harder
- Grammar focus should be practical (word order, basic conjugation, etc)

Return ONLY valid JSON. No markdown, no code blocks, no explanations.`;

        try {
            console.log('📡 Calling Gemini 2.0 Flash API...');
            
            const response = await fetch(`${this.API_URL}?key=${this.API_KEY}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{ 
                        parts: [{ text: prompt }] 
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 2048,
                        responseMimeType: "application/json"
                    }
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ API Error:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            console.log('📥 API Response received');
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                console.error('❌ Invalid response structure:', data);
                return null;
            }
            
            const text = data.candidates[0].content.parts[0].text;
            console.log('📝 Generated text length:', text.length);
            
            // Try to parse directly (with responseMimeType JSON, it should be clean)
            try {
                const lessonData = JSON.parse(text);
                console.log('✅ Parsed lesson:', lessonData.title);
                return lessonData;
            } catch (parseError) {
                // Fallback: extract JSON from markdown if needed
                console.log('⚠️ Direct parse failed, trying extraction...');
                
                let jsonMatch = text.match(/\{[\s\S]*\}/);
                
                if (!jsonMatch) {
                    jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/) || 
                               text.match(/```\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) {
                        jsonMatch = [jsonMatch[1]];
                    }
                }
                
                if (jsonMatch) {
                    const lessonData = JSON.parse(jsonMatch[0]);
                    console.log('✅ Extracted and parsed lesson:', lessonData.title);
                    return lessonData;
                }
                
                console.error('❌ Could not extract JSON from response');
                return null;
            }
            
        } catch (error) {
            console.error('❌ Error generating lesson:', error);
            return null;
        }
    }
};
// ============ LESSON MANAGER ============
        const LessonManager = {
            currentLesson: null,
            currentExercise: 0,
            correctAnswers: 0,
            totalExercises: 0,
            selectedAnswer: null,

async startLesson(lessonId) {
    this.currentLesson = App.lessons.find(l => l.id === lessonId);
    if (!this.currentLesson) {
        console.error('Lesson not found', lessonId, 'Available:', App.lessons.map(l => l.id));
        return;
    }
    if (!this.currentLesson.exercises || this.currentLesson.exercises.length === 0) {
        console.error('No exercises found for lesson', lessonId);
        alert('This lesson has no exercises. Please try another lesson.');
        return;
    }
    this.currentExercise = 0;
    this.correctAnswers = 0;
    this.totalExercises = this.currentLesson.exercises.length;
                this.selectedAnswer = null;

                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('lesson-screen').classList.add('active');

                this.displayExercise();
            },

displayExercise() {
    const exercise = this.currentLesson.exercises[this.currentExercise];
    const questionContainer = document.getElementById('question-container');
    const answerOptions = document.getElementById('answer-options');
    const checkBtn = document.getElementById('check-answer-btn');

    const progress = ((this.currentExercise + 1) / this.totalExercises) * 100;
    document.getElementById('lesson-progress').style.width = `${progress}%`;

    this.selectedAnswer = null;
    checkBtn.disabled = true;
    checkBtn.style.display = 'block';
    answerOptions.innerHTML = '';
    answerOptions.style.display = 'flex';
    answerOptions.style.flexDirection = 'column';
    answerOptions.style.gap = '12px';

    if (exercise.type === 'sentence-builder') {
        this.displaySentenceBuilder(exercise, questionContainer, answerOptions, checkBtn);
        return;
    } else if (exercise.type === 'fill-blank') {
        this.displayFillBlank(exercise, questionContainer, answerOptions);
    } else if (exercise.type === 'translation-full') {
        this.displayTranslationFull(exercise, questionContainer, answerOptions, checkBtn);
        return;
    } else {
        questionContainer.innerHTML = `
            <div class="question">
                <h3>${exercise.question}</h3>
            </div>
        `;
    }

    if (exercise.options) {
        const shuffled = [...exercise.options].sort(() => Math.random() - 0.5);
        shuffled.forEach(option => {
            const button = document.createElement('button');
            button.className = 'answer-option';
            button.textContent = option;
            button.onclick = () => this.selectAnswer(option, button);
            answerOptions.appendChild(button);
        });
    }
},

selectAnswer(answer, button) {
    document.querySelectorAll('#lesson-screen .answer-option').forEach(btn => {
        btn.classList.remove('selected');
    });
    button.classList.add('selected');
    this.selectedAnswer = answer;
    document.getElementById('check-answer-btn').disabled = false;
},

checkAnswer() {
    const exercise = this.currentLesson.exercises[this.currentExercise];
    let isCorrect = false;

    // Handle different exercise types
    if (exercise.type === 'sentence-builder') {
        isCorrect = this.selectedAnswer === exercise.correctOrder.join(' ');
    } else if (exercise.type === 'translation-full') {
        // More lenient checking for typed translations
        const userAnswer = this.selectedAnswer.toLowerCase().trim();
        const correctAnswer = exercise.answer.toLowerCase().trim();
        isCorrect = userAnswer === correctAnswer || 
                   this.calculateSimilarity(userAnswer, correctAnswer) > 0.85;
    } else {
        // Standard exercises
        isCorrect = this.selectedAnswer === exercise.answer;
    }

    if (isCorrect) {
        this.correctAnswers++;
    }
    
    // Track vocabulary performance
    if (exercise.type === 'translation' || exercise.type === 'multiple-choice' || exercise.type === 'fill-blank') {
        const vocabWord = this.currentLesson.vocabulary.find(v => 
            v.lithuanian === exercise.answer || v.english === exercise.answer
        );
        
        if (vocabWord) {
            Storage.addVocabulary(vocabWord.lithuanian, 1, isCorrect);
        }
    } else if (exercise.vocabularyWord) {
        // For sentence-builder and other new types
        Storage.addVocabulary(exercise.vocabularyWord, 1, isCorrect);
    }

    this.showFeedback(isCorrect, exercise.answer);
},

            showFeedback(isCorrect, correctAnswer) {
                const feedbackPanel = document.getElementById('feedback-panel');
                const feedbackTitle = document.getElementById('feedback-title');
                const feedbackMessage = document.getElementById('feedback-message');

                feedbackPanel.classList.remove('hidden', 'correct', 'incorrect');
                feedbackPanel.classList.add(isCorrect ? 'correct' : 'incorrect');

                if (isCorrect) {
                    feedbackTitle.textContent = '✓ Correct!';
                    feedbackMessage.textContent = 'Great job! Keep it up.';
                } else {
                    feedbackTitle.textContent = '✗ Incorrect';
                    feedbackMessage.textContent = `Correct answer: ${correctAnswer}`;
                }

                document.querySelectorAll('#lesson-screen .answer-option').forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    } else if (btn.classList.contains('selected') && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                    btn.disabled = true;
                });
            },

            continueLesson() {
                const feedbackPanel = document.getElementById('feedback-panel');
                feedbackPanel.classList.add('hidden');

                this.currentExercise++;

                if (this.currentExercise >= this.totalExercises) {
                    this.completeLesson();
                } else {
                    this.displayExercise();
                }
            },

            completeLesson() {
                const accuracy = Math.round((this.correctAnswers / this.totalExercises) * 100);
                const xpEarned = this.currentLesson.xp;

                Storage.completeLesson(this.currentLesson.id, accuracy);
                Storage.addXP(xpEarned);
                StreakManager.updateStreak();

                this.currentLesson.vocabulary.forEach(word => {
                    Storage.addVocabulary(word.lithuanian);
                });

                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('results-screen').classList.add('active');

                document.getElementById('correct-answers').textContent = `${this.correctAnswers}/${this.totalExercises}`;
                document.getElementById('xp-earned').textContent = xpEarned;
                document.getElementById('accuracy').textContent = `${accuracy}%`;
            },

            exitLesson() {
                if (confirm('Are you sure you want to exit? Progress will not be saved.')) {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    document.getElementById('home-screen').classList.add('active');
                }
            },
            displaySentenceBuilder(exercise, questionContainer, answerOptions, checkBtn) {
    questionContainer.innerHTML = `
        <div class="question">
            <h3>Build the sentence:</h3>
            <p style="color: var(--text-light); margin-top: 8px;">${exercise.translation}</p>
            <div id="lesson-selected-words" style="min-height: 60px; background: var(--bg-light); border-radius: 12px; padding: 16px; margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                <span style="color: var(--text-light);">Tap words below to build sentence...</span>
            </div>
        </div>
    `;
    this.sentenceBuilder = {
        selected: [],
        available: [...exercise.words].sort(() => Math.random() - 0.5)
    };
    answerOptions.innerHTML = '';
    answerOptions.style.display = 'flex';
    answerOptions.style.flexWrap = 'wrap';
    answerOptions.style.gap = '8px';
    this.sentenceBuilder.available.forEach(word => {
        const button = document.createElement('button');
        button.className = 'answer-option';
        button.textContent = word;
        button.style.flex = '0 0 auto';
        button.onclick = () => this.addWordToSentence(word, button);
        answerOptions.appendChild(button);
    });
    checkBtn.disabled = true;
},

addWordToSentence(word, button) {
    this.sentenceBuilder.selected.push(word);
    button.disabled = true;
    button.style.opacity = '0.3';
    
    const selectedContainer = document.getElementById('lesson-selected-words');
    selectedContainer.innerHTML = '';
    
    this.sentenceBuilder.selected.forEach((w, index) => {
        const wordSpan = document.createElement('span');
        wordSpan.textContent = w;
        wordSpan.style.cssText = 'background: var(--white); padding: 8px 12px; border-radius: 8px; border: 2px solid var(--primary-color); cursor: pointer; font-weight: 600;';
        wordSpan.onclick = () => this.removeWordFromSentence(index);
        selectedContainer.appendChild(wordSpan);
    });
    
    // FIX: Use this.currentLesson.exercises instead of this.exercises
    const exercise = this.currentLesson.exercises[this.currentExercise];
    this.selectedAnswer = this.sentenceBuilder.selected.join(' ');
    document.getElementById('check-answer-btn').disabled = 
        this.sentenceBuilder.selected.length !== exercise.correctOrder.length;
},

removeWordFromSentence(index) {
    const word = this.sentenceBuilder.selected[index];
    this.sentenceBuilder.selected.splice(index, 1);
    
    const answerOptions = document.getElementById('answer-options');
    const buttons = answerOptions.querySelectorAll('.answer-option');
    buttons.forEach(btn => {
        if (btn.textContent === word && btn.disabled) {
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    });
    
    const selectedContainer = document.getElementById('lesson-selected-words');
    if (this.sentenceBuilder.selected.length === 0) {
        selectedContainer.innerHTML = '<span style="color: var(--text-light);">Tap words below to build sentence...</span>';
    } else {
        selectedContainer.innerHTML = '';
        this.sentenceBuilder.selected.forEach((w, idx) => {
            const wordSpan = document.createElement('span');
            wordSpan.textContent = w;
            wordSpan.style.cssText = 'background: var(--white); padding: 8px 12px; border-radius: 8px; border: 2px solid var(--primary-color); cursor: pointer; font-weight: 600;';
            wordSpan.onclick = () => this.removeWordFromSentence(idx);
            selectedContainer.appendChild(wordSpan);
        });
    }
    
    // FIX: Use this.currentLesson.exercises instead of this.exercises
    const exercise = this.currentLesson.exercises[this.currentExercise];
    this.selectedAnswer = this.sentenceBuilder.selected.join(' ');
    document.getElementById('check-answer-btn').disabled = 
        this.sentenceBuilder.selected.length !== exercise.correctOrder.length;
},

displayFillBlank(exercise, questionContainer, answerOptions) {
    const sentenceParts = exercise.sentence.split('____');
    questionContainer.innerHTML = `
        <div class="question">
            <h3>Fill in the blank:</h3>
            <div style="background: var(--bg-light); padding: 20px; border-radius: 12px; margin: 16px 0; font-size: 20px; text-align: center;">
                ${sentenceParts[0]}<span style="color: var(--primary-color); font-weight: 700;">____</span>${sentenceParts[1] || ''}
            </div>
            <p style="color: var(--text-light); font-size: 14px;">${exercise.translation}</p>
        </div>
    `;
},

displayTranslationFull(exercise, questionContainer, answerOptions, checkBtn) {
    questionContainer.innerHTML = `
        <div class="question">
            <h3>Translate to Lithuanian:</h3>
            <p style="font-size: 18px; margin: 16px 0; font-weight: 600;">${exercise.question.replace('Translate: ', '')}</p>
            ${exercise.hints ? `<p style="color: var(--warning-color); font-size: 14px; margin-top: 8px;">💡 Hint: ${exercise.hints[0]}</p>` : ''}
            <textarea id="lesson-translation-input" 
                      style="width: 100%; min-height: 80px; margin-top: 16px; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 16px; font-family: inherit;"
                      placeholder="Type your translation here..."></textarea>
        </div>
    `;
    answerOptions.style.display = 'none';
    const input = document.getElementById('lesson-translation-input');
    input.addEventListener('input', (e) => {
        this.selectedAnswer = e.target.value.trim();
        checkBtn.disabled = this.selectedAnswer.length < 3;
    });
    input.focus();
},

calculateSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    if (longer.length === 0) return 1.0;
    const editDistance = this.levenshteinDistance(longer, shorter);
    return (longer.length - editDistance) / longer.length;
},

levenshteinDistance(str1, str2) {
    const matrix = [];
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    return matrix[str2.length][str1.length];
}
        };

      // ============ PRACTICE MANAGER ============
const PracticeManager = {
    currentMode: null,
    currentExercise: 0,
    totalExercises: 10,
    correctAnswers: 0,
    exercises: [],
    selectedAnswer: null,
    recognition: null,

    startWeakWords() {
        this.currentMode = 'weak';
        const weakWords = Storage.getWeakWords(10);
        
        if (weakWords.length === 0) {
            alert('Great job! You have no weak words yet. Complete more lessons to practice!');
            return;
        }
        
        this.exercises = this.generateExercisesFromWords(weakWords);
        this.startPractice('Weak Words Practice');
    },

    startReview() {
        this.currentMode = 'review';
        const reviewWords = Storage.getWordsForReview(10);
        
        if (reviewWords.length === 0) {
            alert('No words to review yet! Complete some lessons first.');
            return;
        }
        
        this.exercises = this.generateExercisesFromWords(reviewWords);
        this.startPractice('Review Practice');
    },

    startSpeaking() {
        this.currentMode = 'speaking';
        
        // Check if browser supports speech recognition
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Sorry, your browser doesn\'t support speech recognition. Try Chrome or Edge!');
            return;
        }
        
        const userData = Storage.getUserData();
        const allWords = Object.keys(userData.vocabulary);
        
        if (allWords.length === 0) {
            alert('Learn some vocabulary first!');
            return;
        }
        
        const selectedWords = this.getRandomWords(allWords, 10);
        this.exercises = this.generateSpeakingExercises(selectedWords, userData.vocabulary);
        this.startPractice('Speaking Practice');
    },

    startListening() {
        this.currentMode = 'listening';
        
        // Check if browser supports speech synthesis
        if (!('speechSynthesis' in window)) {
            alert('Sorry, your browser doesn\'t support text-to-speech!');
            return;
        }
        
        const userData = Storage.getUserData();
        const allWords = Object.keys(userData.vocabulary);
        
        if (allWords.length === 0) {
            alert('Learn some vocabulary first!');
            return;
        }
        
        const selectedWords = this.getRandomWords(allWords, 10);
        this.exercises = this.generateListeningExercises(selectedWords, userData.vocabulary);
        this.startPractice('Listening Practice');
    },

    getRandomWords(words, count) {
        const shuffled = [...words].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, Math.min(count, words.length));
    },

    generateExercisesFromWords(words) {
        const exercises = [];
        const userData = Storage.getUserData();
        
        // Get all vocabulary for generating wrong options
        const allVocab = [];
        LESSONS_DATA.lessons.forEach(lesson => {
            if (lesson.vocabulary) {
                allVocab.push(...lesson.vocabulary);
            }
        });
        
        words.forEach(wordData => {
            const vocab = allVocab.find(v => v.lithuanian === wordData.word);
            if (!vocab) return;
            
            // Generate different types of exercises
            const exerciseType = Math.random();
            
            if (exerciseType < 0.5) {
                // Lithuanian to English
                const wrongOptions = allVocab
                    .filter(v => v.english !== vocab.english)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3)
                    .map(v => v.english);
                
                exercises.push({
                    type: 'translation',
                    question: `What does "${vocab.lithuanian}" mean?`,
                    answer: vocab.english,
                    options: [vocab.english, ...wrongOptions].sort(() => Math.random() - 0.5),
                    vocabularyWord: vocab.lithuanian
                });
            } else {
                // English to Lithuanian
                const wrongOptions = allVocab
                    .filter(v => v.lithuanian !== vocab.lithuanian)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3)
                    .map(v => v.lithuanian);
                
                exercises.push({
                    type: 'translation',
                    question: `How do you say "${vocab.english}" in Lithuanian?`,
                    answer: vocab.lithuanian,
                    options: [vocab.lithuanian, ...wrongOptions].sort(() => Math.random() - 0.5),
                    vocabularyWord: vocab.lithuanian
                });
            }
        });
        
        return exercises.sort(() => Math.random() - 0.5);
    },

    generateSpeakingExercises(words, vocabData) {
        const exercises = [];
        const allVocab = [];
        
        LESSONS_DATA.lessons.forEach(lesson => {
            if (lesson.vocabulary) {
                allVocab.push(...lesson.vocabulary);
            }
        });
        
        words.forEach(word => {
            const vocab = allVocab.find(v => v.lithuanian === word);
            if (!vocab) return;
            
            exercises.push({
                type: 'speaking',
                question: `Say "${vocab.lithuanian}" in Lithuanian`,
                hint: `Pronunciation: ${vocab.pronunciation}`,
                answer: vocab.lithuanian,
                english: vocab.english,
                vocabularyWord: vocab.lithuanian
            });
        });
        
        return exercises;
    },

    generateListeningExercises(words, vocabData) {
        const exercises = [];
        const allVocab = [];
        
        LESSONS_DATA.lessons.forEach(lesson => {
            if (lesson.vocabulary) {
                allVocab.push(...lesson.vocabulary);
            }
        });
        
        words.forEach(word => {
            const vocab = allVocab.find(v => v.lithuanian === word);
            if (!vocab) return;
            
            const wrongOptions = allVocab
                .filter(v => v.english !== vocab.english)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(v => v.english);
            
            exercises.push({
                type: 'listening',
                audioText: vocab.lithuanian,
                question: 'What did you hear?',
                answer: vocab.english,
                options: [vocab.english, ...wrongOptions].sort(() => Math.random() - 0.5),
                vocabularyWord: vocab.lithuanian
            });
        });
        
        return exercises;
    },

    startPractice(title) {
        this.currentExercise = 0;
        this.correctAnswers = 0;
        this.selectedAnswer = null;
        this.totalExercises = this.exercises.length;
        
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('practice-exercise-screen').classList.add('active');
        
        this.displayExercise();
    },

displayExercise() {
    const exercise = this.exercises[this.currentExercise];
    const questionContainer = document.getElementById('practice-question-container');
    const answerOptions = document.getElementById('practice-answer-options');
    const checkBtn = document.getElementById('practice-check-btn');

    const progress = ((this.currentExercise + 1) / this.totalExercises) * 100;
    document.getElementById('practice-progress').style.width = `${progress}%`;
    document.getElementById('practice-counter').textContent = `${this.currentExercise + 1}/${this.totalExercises}`;

    this.selectedAnswer = null;
    checkBtn.disabled = true;
    checkBtn.style.display = 'block';
    answerOptions.innerHTML = '';

    if (exercise.type === 'listening') {
        questionContainer.innerHTML = `
            <div class="question">
                <div style="text-align: center; margin-bottom: 24px;">
                    <button id="play-audio-btn" class="btn btn-secondary" 
                            style="font-size: 48px; padding: 32px; border-radius: 50%; width: 120px; height: 120px;">
                        🔊
                    </button>
                </div>
                <h3>${exercise.question}</h3>
                <p style="color: var(--text-light); font-size: 14px;">Click the speaker to listen</p>
            </div>
        `;
        
        document.getElementById('play-audio-btn').addEventListener('click', () => {
            this.speak(exercise.audioText);
        });
        
        setTimeout(() => this.speak(exercise.audioText), 500);
    } else if (exercise.type === 'speaking') {
        questionContainer.innerHTML = `
            <div class="question">
                <h3>${exercise.question}</h3>
                <p style="color: var(--text-light); margin-top: 8px;">${exercise.hint}</p>
                <p style="color: var(--text-light); font-size: 14px; margin-top: 16px;">
                    English: ${exercise.english}
                </p>
                <div style="text-align: center; margin-top: 32px;">
                    <button id="record-btn" class="btn btn-secondary" 
                            style="font-size: 48px; padding: 32px; border-radius: 50%; width: 120px; height: 120px;">
                        🎤
                    </button>
                    <p id="recording-status" style="margin-top: 16px; font-weight: 600;">
                        Click to start recording
                    </p>
                </div>
            </div>
        `;
        
        document.getElementById('record-btn').addEventListener('click', () => {
            this.startRecording();
        });
        
        answerOptions.innerHTML = '';
        checkBtn.style.display = 'none';
        return;
    } else {
        questionContainer.innerHTML = `
            <div class="question">
                <h3>${exercise.question}</h3>
            </div>
        `;
    }

    if (exercise.options) {
        exercise.options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'answer-option';
            button.textContent = option;
            button.onclick = () => this.selectAnswer(option, button);
            answerOptions.appendChild(button);
        });
    }
},

selectAnswer(answer, button) {
    document.querySelectorAll('#practice-exercise-screen .answer-option').forEach(btn => {
        btn.classList.remove('selected');
    });
    button.classList.add('selected');
    this.selectedAnswer = answer;
    document.getElementById('practice-check-btn').disabled = false;
},

displaySentenceBuilder(exercise, questionContainer, answerOptions, checkBtn) {
    questionContainer.innerHTML = `
        <div class="question">
            <h3>Build the sentence:</h3>
            <p style="color: var(--text-light); margin-top: 8px;">${exercise.translation}</p>
            <div id="selected-words" style="min-height: 60px; background: var(--bg-light); border-radius: 12px; padding: 16px; margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                <span style="color: var(--text-light);">Tap words below to build sentence...</span>
            </div>
        </div>
    `;

    this.sentenceBuilder = {
        selected: [],
        available: [...exercise.words].sort(() => Math.random() - 0.5)
    };

    answerOptions.innerHTML = '';
    answerOptions.style.display = 'flex';
    answerOptions.style.flexWrap = 'wrap';
    answerOptions.style.gap = '8px';

    this.sentenceBuilder.available.forEach(word => {
        const button = document.createElement('button');
        button.className = 'answer-option';
        button.textContent = word;
        button.style.flex = '0 0 auto';
        button.onclick = () => this.addWordToSentence(word, button);
        answerOptions.appendChild(button);
    });

    checkBtn.disabled = true;
},

addWordToSentence(word, button) {
    this.sentenceBuilder.selected.push(word);
    button.disabled = true;
    button.style.opacity = '0.3';

    const selectedContainer = document.getElementById('selected-words');
    selectedContainer.innerHTML = '';

    this.sentenceBuilder.selected.forEach((w, index) => {
        const wordSpan = document.createElement('span');
        wordSpan.textContent = w;
        wordSpan.style.cssText = 'background: var(--white); padding: 8px 12px; border-radius: 8px; border: 2px solid var(--primary-color); cursor: pointer; font-weight: 600;';
        wordSpan.onclick = () => this.removeWordFromSentence(index);
        selectedContainer.appendChild(wordSpan);
    });

    const exercise = this.currentLesson.exercises[this.currentExercise];
    this.selectedAnswer = this.sentenceBuilder.selected.join(' ');
    document.getElementById('check-answer-btn').disabled = 
        this.sentenceBuilder.selected.length !== exercise.correctOrder.length;
},

removeWordFromSentence(index) {
    const word = this.sentenceBuilder.selected[index];
    this.sentenceBuilder.selected.splice(index, 1);

    const answerOptions = document.getElementById('answer-options');
    const buttons = answerOptions.querySelectorAll('.answer-option');
    buttons.forEach(btn => {
        if (btn.textContent === word && btn.disabled) {
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    });

    const selectedContainer = document.getElementById('selected-words');
    if (this.sentenceBuilder.selected.length === 0) {
        selectedContainer.innerHTML = '<span style="color: var(--text-light);">Tap words below to build sentence...</span>';
    } else {
        selectedContainer.innerHTML = '';
        this.sentenceBuilder.selected.forEach((w, idx) => {
            const wordSpan = document.createElement('span');
            wordSpan.textContent = w;
            wordSpan.style.cssText = 'background: var(--white); padding: 8px 12px; border-radius: 8px; border: 2px solid var(--primary-color); cursor: pointer; font-weight: 600;';
            wordSpan.onclick = () => this.removeWordFromSentence(idx);
            selectedContainer.appendChild(wordSpan);
        });
    }

    const exercise = this.exercises[this.currentExercise];
    this.selectedAnswer = this.sentenceBuilder.selected.join(' ');
    document.getElementById('check-answer-btn').disabled = 
        this.sentenceBuilder.selected.length !== exercise.correctOrder.length;
},

displayFillBlank(exercise, questionContainer, answerOptions) {
    const sentenceParts = exercise.sentence.split('____');
    questionContainer.innerHTML = `
        <div class="question">
            <h3>Fill in the blank:</h3>
            <div style="background: var(--bg-light); padding: 20px; border-radius: 12px; margin: 16px 0; font-size: 20px; text-align: center;">
                ${sentenceParts[0]}<span style="color: var(--primary-color); font-weight: 700;">____</span>${sentenceParts[1] || ''}
            </div>
            <p style="color: var(--text-light); font-size: 14px;">${exercise.translation}</p>
        </div>
    `;
},

displayTranslationFull(exercise, questionContainer, answerOptions, checkBtn) {
    questionContainer.innerHTML = `
        <div class="question">
            <h3>Translate to Lithuanian:</h3>
            <p style="font-size: 18px; margin: 16px 0; font-weight: 600;">${exercise.question.replace('Translate: ', '')}</p>
            ${exercise.hints ? `<p style="color: var(--warning-color); font-size: 14px; margin-top: 8px;">💡 Hint: ${exercise.hints[0]}</p>` : ''}
            <textarea id="translation-input" 
                      style="width: 100%; min-height: 80px; margin-top: 16px; padding: 12px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 16px; font-family: inherit;"
                      placeholder="Type your translation here..."></textarea>
        </div>
    `;

    answerOptions.style.display = 'none';
    
    const input = document.getElementById('translation-input');
    input.addEventListener('input', (e) => {
        this.selectedAnswer = e.target.value.trim();
        checkBtn.disabled = this.selectedAnswer.length < 3;
    });
    
    input.focus();
},

checkAnswer() {
    const exercise = this.exercises[this.currentExercise];
    let isCorrect = false;

    // Handle different exercise types
    if (exercise.type === 'sentence-builder') {
        isCorrect = this.selectedAnswer === exercise.correctOrder.join(' ');
    } else if (exercise.type === 'translation-full') {
        const userAnswer = this.selectedAnswer.toLowerCase().trim();
        const correctAnswer = exercise.answer.toLowerCase().trim();
        isCorrect = userAnswer === correctAnswer || 
                   this.calculateSimilarity(userAnswer, correctAnswer) > 0.85;
    } else {
        isCorrect = this.selectedAnswer === exercise.answer;
    }
    
    // Update vocabulary strength
    if (exercise.vocabularyWord) {
        Storage.addVocabulary(exercise.vocabularyWord, 1, isCorrect);
    }
    
    this.showFeedback(isCorrect, exercise.answer);
},

showFeedback(isCorrect, correctAnswer) {
    const feedbackPanel = document.getElementById('practice-feedback-panel');
    const feedbackTitle = document.getElementById('practice-feedback-title');
    const feedbackMessage = document.getElementById('practice-feedback-message');
    
    feedbackPanel.classList.remove('hidden', 'correct', 'incorrect');
    feedbackPanel.classList.add(isCorrect ? 'correct' : 'incorrect');
    
    if (isCorrect) {
        this.correctAnswers++;  
        feedbackTitle.textContent = '✓ Correct!';
        feedbackMessage.textContent = 'Great job!';
    } else {
        feedbackTitle.textContent = '✗ Incorrect';
        feedbackMessage.textContent = `Correct answer: ${correctAnswer}`;
    }
    
    document.querySelectorAll('#practice-exercise-screen .answer-option').forEach(btn => {
        if (btn.textContent === correctAnswer) {
            btn.classList.add('correct');
        } else if (btn.classList.contains('selected') && !isCorrect) {
            btn.classList.add('incorrect');
        }
        btn.disabled = true;
    });
},
    continuePractice() {
        const feedbackPanel = document.getElementById('practice-feedback-panel');
        feedbackPanel.classList.add('hidden');
        
        this.currentExercise++;
        
        if (this.currentExercise >= this.totalExercises) {
            this.completePractice();
        } else {
            this.displayExercise();
        }
    },

    completePractice() {
        const accuracy = Math.round((this.correctAnswers / this.totalExercises) * 100);
        const xpEarned = Math.round(this.correctAnswers * 2);
        
        Storage.addXP(xpEarned);
        StreakManager.updateStreak();
        
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('practice-results-screen').classList.add('active');
        
        document.getElementById('practice-correct-answers').textContent = 
            `${this.correctAnswers}/${this.totalExercises}`;
        document.getElementById('practice-xp-earned').textContent = xpEarned;
        document.getElementById('practice-accuracy').textContent = `${accuracy}%`;
    },

    speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'lt-LT';
            utterance.rate = 0.8;
            utterance.pitch = 1;
            
            window.speechSynthesis.speak(utterance);
        }
    },

    startRecording() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!this.recognition) {
            this.recognition = new SpeechRecognition();
            this.recognition.lang = 'lt-LT';
            this.recognition.continuous = false;
            this.recognition.interimResults = false;
        }
        
        const recordBtn = document.getElementById('record-btn');
        const status = document.getElementById('recording-status');
        
        recordBtn.textContent = '⏺️';
        status.textContent = 'Listening... Speak now!';
        status.style.color = 'var(--danger-color)';
        
        this.recognition.start();
        
        this.recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase().trim();
            const exercise = this.exercises[this.currentExercise];
            const expected = exercise.answer.toLowerCase().trim();
            
            recordBtn.textContent = '🎤';
            
            console.log('Heard:', transcript, 'Expected:', expected);
            
            // Simple matching (we can make this more sophisticated)
            const isCorrect = transcript.includes(expected) || 
                             expected.includes(transcript) ||
                             this.calculateSimilarity(transcript, expected) > 0.7;
            
            if (isCorrect) {
                this.correctAnswers++;
                status.textContent = '✓ Correct pronunciation!';
                status.style.color = 'var(--success-color)';
                Storage.addVocabulary(exercise.vocabularyWord, 1, true);
            } else {
                status.textContent = `✗ Try again. You said: "${transcript}"`;
                status.style.color = 'var(--danger-color)';
                Storage.addVocabulary(exercise.vocabularyWord, 1, false);
            }
            
            setTimeout(() => this.continuePractice(), 2000);
        };
        
        this.recognition.onerror = (event) => {
            recordBtn.textContent = '🎤';
            status.textContent = 'Error: ' + event.error + '. Try again!';
            status.style.color = 'var(--danger-color)';
        };
        
        this.recognition.onend = () => {
            recordBtn.textContent = '🎤';
            if (status.textContent === 'Listening... Speak now!') {
                status.textContent = 'Click to try again';
                status.style.color = 'var(--text-light)';
            }
        };
    },

    calculateSimilarity(str1, str2) {
        const longer = str1.length > str2.length ? str1 : str2;
        const shorter = str1.length > str2.length ? str2 : str1;
        
        if (longer.length === 0) return 1.0;
        
        const editDistance = this.levenshteinDistance(longer, shorter);
        return (longer.length - editDistance) / longer.length;
    },

    levenshteinDistance(str1, str2) {
        const matrix = [];
        
        for (let i = 0; i <= str2.length; i++) {
            matrix[i] = [i];
        }
        
        for (let j = 0; j <= str1.length; j++) {
            matrix[0][j] = j;
        }
        
        for (let i = 1; i <= str2.length; i++) {
            for (let j = 1; j <= str1.length; j++) {
                if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j] + 1
                    );
                }
            }
        }
        
        return matrix[str2.length][str1.length];
    },

    updateStats() {
        const userData = Storage.getUserData();
        const vocabCount = Object.keys(userData.vocabulary).length;
        const weakCount = Storage.getWeakWords(100).length;
        
        document.getElementById('vocab-count').textContent = vocabCount;
        document.getElementById('review-count').textContent = weakCount;
    }
};

        // ============ PROFILE MANAGER ============
        const ProfileManager = {
            updateProfile() {
                const userData = Storage.getUserData();
                const vocabCount = Object.keys(userData.vocabulary).length;
                const level = Math.floor(userData.totalXP / 50) + 1;

                document.getElementById('profile-xp').textContent = userData.totalXP;
                document.getElementById('profile-streak').textContent = userData.streak;
                document.getElementById('profile-lessons').textContent = userData.lessonsCompleted.length;
                document.getElementById('profile-vocab').textContent = vocabCount;
                document.getElementById('user-level').textContent = level;

                this.updateAchievements();
            },

            updateAchievements() {
                const userData = Storage.getUserData();
                const container = document.getElementById('achievements-container');
                container.innerHTML = '';

                ACHIEVEMENTS.forEach(achievement => {
                    let isUnlocked = false;
                    
                    switch (achievement.type) {
                        case 'lessons':
                            isUnlocked = userData.lessonsCompleted.length >= achievement.requirement;
                            break;
                        case 'streak':
                            isUnlocked = userData.streak >= achievement.requirement;
                            break;
                        case 'vocabulary':
                            isUnlocked = Object.keys(userData.vocabulary).length >= achievement.requirement;
                            break;
                        case 'xp':
                            isUnlocked = userData.totalXP >= achievement.requirement;
                            break;
                    }

                    const achievementEl = document.createElement('div');
                    achievementEl.className = `achievement ${isUnlocked ? 'unlocked' : ''}`;
                    achievementEl.innerHTML = `
                        <div class="achievement-icon">${isUnlocked ? achievement.icon : '🔒'}</div>
                        <div class="achievement-name">${achievement.name}</div>
                    `;
                    container.appendChild(achievementEl);
                });
            }
        };
// ============ ANALYTICS MANAGER ============
const Analytics = {
    updateAnalytics() {
        this.updateWeeklyStats();
        this.updateWeakAreas();
        this.updateStreakCalendar();
    },

    updateWeeklyStats() {
        const userData = Storage.getUserData();
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

        const weekLessons = userData.lessonsCompleted.filter(l => 
            new Date(l.completedAt) > oneWeekAgo
        );

        const weekWords = Object.entries(userData.vocabulary).filter(([word, stats]) =>
            new Date(stats.lastReviewed) > oneWeekAgo
        ).length;

        const weekXP = weekLessons.reduce((sum, l) => {
            const lesson = App.lessons.find(les => les.id === l.id);
            return sum + (lesson ? lesson.xp : 0);
        }, 0);

        const avgAccuracy = weekLessons.length > 0
            ? Math.round(weekLessons.reduce((sum, l) => sum + l.score, 0) / weekLessons.length)
            : 0;

        document.getElementById('week-xp').textContent = weekXP;
        document.getElementById('week-lessons').textContent = weekLessons.length;
        document.getElementById('week-accuracy').textContent = avgAccuracy + '%';
        document.getElementById('week-words').textContent = weekWords;
    },

    updateWeakAreas() {
        const weakWords = Storage.getWeakWords(5);
        const container = document.getElementById('weak-areas-list');

        if (weakWords.length === 0) {
            container.innerHTML = '<p style="color: var(--text-light);">No weak areas yet! Keep learning.</p>';
            return;
        }

        container.innerHTML = '';
        weakWords.forEach(wordData => {
            const vocab = App.lessons
                .flatMap(l => l.vocabulary || [])
                .find(v => v.lithuanian === wordData.word);

            if (!vocab) return;

            const wordDiv = document.createElement('div');
            wordDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-light); border-radius: 8px; margin-bottom: 8px;';
            
            const accuracy = wordData.timesCorrect / (wordData.timesCorrect + wordData.timesWrong) * 100;
            const color = accuracy < 50 ? 'var(--danger-color)' : accuracy < 75 ? 'var(--warning-color)' : 'var(--success-color)';
            
            wordDiv.innerHTML = `
                <div>
                    <strong>${vocab.lithuanian}</strong> - ${vocab.english}
                </div>
                <div style="color: ${color}; font-weight: 600;">
                    ${Math.round(accuracy)}%
                </div>
            `;
            container.appendChild(wordDiv);
        });
    },

    updateStreakCalendar() {
        const container = document.getElementById('streak-calendar');
        const userData = Storage.getUserData();
        container.innerHTML = '';

        const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
        const today = new Date();
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toDateString();
            
            const hasActivity = userData.lessonsCompleted.some(l => 
                new Date(l.completedAt).toDateString() === dateStr
            );

            const dayDiv = document.createElement('div');
            dayDiv.style.cssText = `
                width: 40px;
                height: 40px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 12px;
                background: ${hasActivity ? 'var(--primary-color)' : 'var(--border-color)'};
                color: ${hasActivity ? 'var(--white)' : 'var(--text-light)'};
            `;
            dayDiv.textContent = days[date.getDay() === 0 ? 6 : date.getDay() - 1];
            container.appendChild(dayDiv);
        }
    }
};
        
  // ============ MAIN APP ============
const App = {
    lessons: [],
    userData: null,
    isGenerating: false,

async init() {
        console.log('🚀 Initializing Lithuanian Learning App...');

        this.userData = Storage.getUserData();
        this.lessons = [...LESSONS_DATA.lessons];
        
// Load cached AI lessons BEFORE displaying anything
const cached = localStorage.getItem('aiLessons');
if (cached) {
    try {
        const aiLessons = JSON.parse(cached);
        
        // Validate each cached lesson
        const validLessons = aiLessons.filter(lesson => {
            const isValid = lesson && 
                          lesson.id && 
                          lesson.title && 
                          lesson.exercises && 
                          Array.isArray(lesson.exercises) && 
                          lesson.exercises.length > 0;
            
            if (!isValid) {
                console.warn(`⚠️ Skipping invalid cached lesson:`, lesson?.id || 'unknown');
            }
            return isValid;
        });
        
        if (validLessons.length > 0) {
            // Ensure lesson IDs are correct and sequential
            this.lessons = [
                ...LESSONS_DATA.lessons,
                ...validLessons.map((lesson, index) => ({
                    ...lesson,
                    id: LESSONS_DATA.lessons.length + index + 1
                }))
            ];
            console.log(`📦 Loaded ${validLessons.length} valid AI-generated lessons from cache`);
        } else {
            console.log('⚠️ No valid cached lessons found, will generate fresh');
            localStorage.removeItem('aiLessons');
        }
        
        console.log(`📚 Total lessons: ${this.lessons.length}, IDs: [${this.lessons.map(l => l.id).join(', ')}]`);
    } catch (e) {
        console.error('Error loading cached lessons:', e);
        localStorage.removeItem('aiLessons');
    }
}
        
        StreakManager.init();
        StreakManager.checkDailyReview();
        this.displayLessonPath();
        this.displayUserStats();
        this.setupEventListeners();
        
        PracticeManager.updateStats();
        ProfileManager.updateProfile();

        // Generate next lesson if needed
        setTimeout(() => this.checkAndGenerateLesson(), 2000);

        console.log('✅ App initialized successfully');
        console.log(`📚 Total lessons available: ${this.lessons.length}`);
    },

async checkAndGenerateLesson() {
    const completed = this.userData.lessonsCompleted.length;
    const available = this.lessons.length;
    
    console.log(`📊 Lessons: ${available} available, ${completed} completed`);
    
    // If user is close to running out of lessons (keep 2 lessons ahead)
    if (available - completed <= 2 && !this.isGenerating && available < 15) {
        this.isGenerating = true;
        console.log('🤖 Generating new lesson...');
        
        const nextLessonId = this.lessons.length + 1;
        const newLesson = await GeminiAI.generateLesson(nextLessonId, this.userData);
        
        if (newLesson && newLesson.exercises && newLesson.exercises.length > 0) {
            // Ensure correct ID and validate structure
            newLesson.id = nextLessonId;
            
            // Validate exercises array
            if (!Array.isArray(newLesson.exercises)) {
                console.error('❌ Invalid exercises format');
                this.isGenerating = false;
                return;
            }
            
            this.lessons.push(newLesson);
            
            // Save only AI-generated lessons (not the static ones)
            const aiLessons = this.lessons.slice(LESSONS_DATA.lessons.length);
            try {
                localStorage.setItem('aiLessons', JSON.stringify(aiLessons));
                console.log(`✅ Saved ${aiLessons.length} AI lessons to cache`);
            } catch (e) {
                console.error('❌ Failed to cache lessons:', e);
            }
            
            this.displayLessonPath();
            console.log(`✅ New lesson #${newLesson.id} generated: ${newLesson.title}`);
            console.log(`📚 Total lessons now: ${this.lessons.length}`);
        } else {
            console.error('❌ Failed to generate valid lesson');
        }
        
        this.isGenerating = false;
    } else {
        console.log('✓ Enough lessons available');
    }
},

    displayLessonPath() {
        const lessonPath = document.getElementById('lesson-path');
        lessonPath.innerHTML = '';

        let currentSection = null;

        this.lessons.forEach((lesson, index) => {
            if (lesson.section !== currentSection) {
                currentSection = lesson.section;
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                
                const completedInSection = this.userData.lessonsCompleted.filter(l => {
                    const lessonData = this.lessons.find(les => les.id === l.id);
                    return lessonData && lessonData.section === currentSection;
                }).length;
                
                const totalInSection = this.lessons.filter(l => l.section === currentSection).length;
                
                sectionHeader.innerHTML = `
                    <h3>📂 ${currentSection}</h3>
                    <div class="section-progress">${completedInSection}/${totalInSection} lessons completed</div>
                `;
                lessonPath.appendChild(sectionHeader);
            }

            const isCompleted = this.userData.lessonsCompleted.some(l => l.id === lesson.id);
            const isLocked = index > 0 && !this.userData.lessonsCompleted.some(l => l.id === this.lessons[index - 1].id);

            const lessonCard = document.createElement('div');
            lessonCard.className = `lesson-card ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''}`;
            
            lessonCard.innerHTML = `
                <div class="lesson-icon">${isCompleted ? '✓' : isLocked ? '🔒' : '📚'}</div>
                <div class="lesson-info">
                    <h3>${lesson.title}</h3>
                    <p>${lesson.description}</p>
                    <div class="lesson-meta">
                        <span class="xp-badge">+${lesson.xp} XP</span>
                        <span class="difficulty-badge">${lesson.difficulty}</span>
                    </div>
                </div>
            `;

            if (!isLocked) {
                lessonCard.addEventListener('click', () => {
                    this.startLesson(lesson.id);
                });
            }

            lessonPath.appendChild(lessonCard);
        });
    },

    displayUserStats() {
        document.getElementById('total-xp').textContent = this.userData.totalXP;
        document.getElementById('streak-count').textContent = this.userData.streak;
    },

    startLesson(lessonId) {
        LessonManager.startLesson(lessonId);
    },

    setupEventListeners() {
        document.getElementById('start-lesson-btn').addEventListener('click', () => {
            const nextLesson = this.getNextLesson();
            if (nextLesson) {
                this.startLesson(nextLesson.id);
            }
        });

        // Debug button (optional - can remove later)
        const debugBtn = document.getElementById('debug-lessons-btn');
        if (debugBtn) {
            debugBtn.addEventListener('click', () => {
                console.log('=== LESSON DEBUG ===');
                console.log('Total lessons:', this.lessons.length);
                console.log('Lesson IDs:', this.lessons.map(l => l.id));
                console.log('Completed lessons:', this.userData.lessonsCompleted.map(l => l.id));
                console.log('Next lesson:', this.getNextLesson());
                console.log('Static lessons:', LESSONS_DATA.lessons.length);
                console.log('All lessons:', this.lessons);
                alert(`Lessons: ${this.lessons.length}\nCompleted: ${this.userData.lessonsCompleted.length}\nCheck console for details`);
            });
        }
// Clear corrupted cache button (for debugging)
const clearCacheBtn = document.createElement('button');
clearCacheBtn.textContent = '🗑️ Clear AI Lesson Cache';
clearCacheBtn.className = 'btn btn-secondary';
clearCacheBtn.style.marginTop = '10px';
clearCacheBtn.onclick = () => {
    if (confirm('Clear all AI-generated lessons? You\'ll keep your progress but new lessons will be generated.')) {
        localStorage.removeItem('aiLessons');
        alert('Cache cleared! Refresh the page.');
    }
};
document.getElementById('debug-lessons-btn').parentNode.appendChild(clearCacheBtn);
        document.getElementById('check-answer-btn').addEventListener('click', () => {
            LessonManager.checkAnswer();
        });

        document.getElementById('continue-btn').addEventListener('click', () => {
            LessonManager.continueLesson();
        });

        document.getElementById('continue-learning-btn').addEventListener('click', () => {
            this.returnToHome();
        });

        document.getElementById('exit-lesson-btn').addEventListener('click', () => {
            LessonManager.exitLesson();
        });

        document.getElementById('practice-weak-words').addEventListener('click', () => {
            PracticeManager.startWeakWords();
        });

        document.getElementById('practice-review').addEventListener('click', () => {
            PracticeManager.startReview();
        });

        document.getElementById('practice-speaking').addEventListener('click', () => {
            PracticeManager.startSpeaking();
        });

        document.getElementById('practice-listening').addEventListener('click', () => {
            PracticeManager.startListening();
        });

        document.getElementById('practice-check-btn').addEventListener('click', () => {
            PracticeManager.checkAnswer();
        });

        document.getElementById('practice-continue-btn').addEventListener('click', () => {
            PracticeManager.continuePractice();
        });

        document.getElementById('exit-practice-btn').addEventListener('click', () => {
            if (confirm('Exit practice? Progress will not be saved.')) {
                this.navigateToScreen('practice');
            }
        });

        document.getElementById('back-to-practice-btn').addEventListener('click', () => {
            this.navigateToScreen('practice');
            PracticeManager.updateStats();
        });

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const screen = e.currentTarget.dataset.screen;
                this.navigateToScreen(screen);
            });
        });
    },

    getNextLesson() {
        const lastCompleted = this.userData.lessonsCompleted.length;
        return this.lessons[lastCompleted] || this.lessons[0];
    },

    returnToHome() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('home-screen').classList.add('active');
        
        this.userData = Storage.getUserData();
        this.displayLessonPath();
        this.displayUserStats();
        PracticeManager.updateStats();
        ProfileManager.updateProfile();
        
        // Check if we need more lessons
        this.checkAndGenerateLesson();
    },

    navigateToScreen(screenName) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.screen === screenName) {
                item.classList.add('active');
            }
        });

        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });

        const targetScreen = document.getElementById(`${screenName}-screen`);
        if (targetScreen) {
            targetScreen.classList.add('active');
            
if (screenName === 'practice') {
    PracticeManager.updateStats();
} else if (screenName === 'profile') {
    ProfileManager.updateProfile();
} else if (screenName === 'analytics') {
    Analytics.updateAnalytics();
}
        }
    }
};

// Initialize app
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => App.init());
} else {
    App.init();
}
    </script>
</body>
</html>
